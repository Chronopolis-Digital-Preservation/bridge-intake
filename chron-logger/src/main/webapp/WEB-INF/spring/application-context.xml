<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:rabbit="http://www.springframework.org/schema/rabbit"
       xsi:schemaLocation="http://www.springframework.org/schema/rabbit
                           http://www.springframework.org/schema/rabbit/spring-rabbit-1.1.xsd
                           http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-3.2.xsd">

    <bean id="rabbitConnectionFactory" class="com.rabbitmq.client.ConnectionFactory">
        <property name="requestedHeartbeat" value="60"/>
        <property name="connectionTimeout" value="300"/>
        <property name="virtualHost" value="chronopolis"/>
    </bean>

    <bean id="connectionFactory"
          class="org.springframework.amqp.rabbit.connection.CachingConnectionFactory">
        <constructor-arg ref="rabbitConnectionFactory"/>
        <property name="publisherConfirms" value="true"/>
        <property name="publisherReturns" value="true"/>
        <property name="connectionListeners">
            <list>
                <bean class="org.chronopolis.amqp.ConnectionListenerImpl"/>
            </list>
        </property>
        <property name="addresses" value="adapt-mq.umiacs.umd.edu"/>
    </bean>
    
    <rabbit:admin connection-factory="connectionFactory"/>

    <!-- Set up our queues and bindings in the exchange -->
    <rabbit:queue id="queue.test" name="test.logger.umiacs" durable="true"/>
    <rabbit:queue id="queue.broadcast" name="broadcast.logger.umiacs" durable="true"/>

    <rabbit:topic-exchange id="federatedExchange" name="chronopolis-control"> 
        <rabbit:bindings>
            <rabbit:binding queue="queue.test" pattern="test.umiacs"/>
            <rabbit:binding queue="queue.broadcast" pattern="*.*.*"/>
        </rabbit:bindings>
    </rabbit:topic-exchange>


    <!-- Set up our processors/listener -->
    <bean id="genericMessageProcessor" class="org.chronopolis.messaging.logger.processor.GenericMessageProcessor">
        <constructor-arg ref="producer"/> 
    </bean>

    <bean id="msgListener" class="org.chronopolis.messaging.logger.LogMessageListener">
        <constructor-arg ref="genericMessageProcessor"/>
    </bean>

    <bean id="errorHandler" class="org.chronopolis.amqp.error.ErrorHandlerImpl"/>

    <rabbit:listener-container connection-factory="connectionFactory"
                               error-handler="errorHandler"> 
        <rabbit:listener ref="msgListener"
            queues="queue.test,queue.broadcast,queue.direct"/>
    </rabbit:listener-container>

    <rabbit:template id="rabbitTemplate" exchange="chronopolis-control" 
                     connection-factory="connectionFactory"
                     mandatory="true" />

    <!--
                     confirm-callback="confirmCallback"
                     return-callback=""/> 
                     -->

    <bean id="producer" class="org.chronopolis.amqp.TopicProducer">
        <constructor-arg index="0" ref="rabbitTemplate"/>
    </bean>

</beans>