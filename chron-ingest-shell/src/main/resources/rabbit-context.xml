<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:rabbit="http://www.springframework.org/schema/rabbit"
       xsi:schemaLocation="http://www.springframework.org/schema/rabbit
                           		     http://www.springframework.org/schema/rabbit/spring-rabbit-1.1.xsd
                           		     http://www.springframework.org/schema/beans
                           		     http://www.springframework.org/schema/beans/spring-beans-3.2.xsd">

    <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="locations">
            <list>
                <value>classpath:ingest.properties</value>
                <value>file:ingest.properties</value>
            </list>
        </property>
    </bean>

    <bean id="properties" class="org.chronopolis.ingest.IngestProperties">
        <constructor-arg value="${nodeName}"/>
        <constructor-arg value="${stage}"/>
        <constructor-arg value="${tokenStage}" />
        <constructor-arg value="${imsHostName}"/>
    </bean>

    <bean id="rabbitConnectionFactory" class="com.rabbitmq.client.ConnectionFactory">
        <property name="requestedHeartbeat" value="60"/>
        <property name="connectionTimeout" value="300"/>
        <property name="virtualHost" value="chronopolis"/>
    </bean>

    <bean id="connectionFactory"
          class="org.springframework.amqp.rabbit.connection.CachingConnectionFactory">
        <constructor-arg ref="rabbitConnectionFactory"/>
        <property name="publisherConfirms" value="true"/>
        <property name="publisherReturns" value="true"/>
        <property name="connectionListeners">
            <list>
                <bean class="org.chronopolis.amqp.ConnectionListenerImpl"/>
            </list>
        </property>
        <property name="addresses" value="adapt-mq.umiacs.umd.edu"/>
    </bean>
    
    <rabbit:admin connection-factory="connectionFactory"/>

    <!-- Set up our queues and bindings in the exchange -->
    <rabbit:queue id="queue.test" name="test.ingest.umiacs" durable="true"/>
    <rabbit:queue id="queue.broadcast" name="broadcast.ingest.umiacs" durable="true"/>
    <rabbit:queue id="queue.direct-ingest" name="direct.ingest.umiacs" durable="true"/>
    <rabbit:queue id="queue.direct-collection" name="direct.collection.umiacs" durable="true"/>

    <rabbit:topic-exchange id="federatedExchange" name="chronopolis-control"> 
        <rabbit:bindings>
            <rabbit:binding queue="queue.test" pattern="test.umiacs"/>
            <rabbit:binding queue="queue.broadcast" pattern="package.ingest.broadcast"/>
            <rabbit:binding queue="queue.direct-ingest" pattern="package.ingest.umiacs"/>
            <rabbit:binding queue="queue.direct-collection" pattern="collection.ingest.umiacs"/>
        </rabbit:bindings>
    </rabbit:topic-exchange>

    <bean id="messageFactory" class="org.chronopolis.messaging.factory.MessageFactory">

    </bean>

    <bean id="packageReadyProcessor" class="org.chronopolis.ingest.processor.PackageReadyProcessor">
        <constructor-arg ref="producer"/>
        <constructor-arg ref="properties"/>
        <constructor-arg ref="messageFactory"/>
    </bean>
    <bean id="packageStatusProcessor" class="org.chronopolis.ingest.processor.PackageIngestStatusQueryProcessor">
        <constructor-arg ref="producer"/> 
    </bean>
    <bean id="collectionInitCompleteProcessor" class="org.chronopolis.ingest.processor.CollectionInitCompleteProcessor">
        <constructor-arg ref="producer"/>
    </bean>

    <bean id="msgListener" class="org.chronopolis.ingest.IngestMessageListener">
        <constructor-arg ref="packageStatusProcessor"/>
        <constructor-arg ref="packageReadyProcessor"/>
        <constructor-arg ref="collectionInitCompleteProcessor"/>
    </bean>

    <bean id="errorHandler" class="org.chronopolis.amqp.error.ErrorHandlerImpl"/>

    <rabbit:listener-container connection-factory="connectionFactory"
                               error-handler="errorHandler"> 
        <rabbit:listener ref="msgListener"
                     queues="queue.test,queue.broadcast,queue.direct-ingest,queue.direct-collection"/>
    </rabbit:listener-container>

    <rabbit:template id="rabbitTemplate" exchange="chronopolis-control" 
                     connection-factory="connectionFactory"
                     mandatory="true" />

    <!--
    confirm-callback="confirmCallback"
    return-callback=""/> 
    -->

    <bean id="producer" class="org.chronopolis.amqp.TopicProducer">
        <constructor-arg index="0" ref="rabbitTemplate"/>
    </bean>

</beans>