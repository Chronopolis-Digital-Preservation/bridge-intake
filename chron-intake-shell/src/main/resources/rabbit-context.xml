<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:rabbit="http://www.springframework.org/schema/rabbit"
       xsi:schemaLocation="http://www.springframework.org/schema/rabbit
                           http://www.springframework.org/schema/rabbit/spring-rabbit-1.1.xsd
                           http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-3.2.xsd">

	<bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="locations">
			<list>
				<value>classpath:intake.properties</value>
				<value>file:intake.properties</value>
			</list>
		</property>
	</bean>

	<bean id="properties" class="org.chronopolis.common.properties.GenericProperties">
		<constructor-arg value="${nodeName}"/>
		<constructor-arg value="${stage}"/>
	</bean>

    <bean id="rabbitConnectionFactory" class="com.rabbitmq.client.ConnectionFactory">
        <property name="requestedHeartbeat" value="60"/>
        <property name="connectionTimeout" value="300"/>
        <property name="virtualHost" value="chronopolis"/>
    </bean>

    <bean id="connectionFactory"
          class="org.springframework.amqp.rabbit.connection.CachingConnectionFactory">
        <constructor-arg ref="rabbitConnectionFactory"/>
        <property name="publisherConfirms" value="true"/>
        <property name="publisherReturns" value="true"/>
        <property name="connectionListeners">
            <list>
                <bean class="org.chronopolis.amqp.ConnectionListenerImpl"/>
            </list>
        </property>
        <property name="addresses" value="adapt-mq.umiacs.umd.edu"/>
    </bean>

    <!-- Set up our queues and bindings in the exchange -->
    <!-- Need to fill out for intake -->

    <!-- Set up our Processors and Listener -->
    <bean id="packageIngestCompleteProcessor" class="org.chronopolis.intake.processor.PackageIngestCompleteProcessor">
        <constructor-arg ref="producer"/>
    </bean>
    <bean id="packageIngestStatusProcessor" class="org.chronopolis.intake.processor.PackageIngestStatusResponseProcessor">
        <constructor-arg ref="producer"/> 
    </bean>

    <bean id="msgListener" class="org.chronopolis.intake.IntakeMessageListener">
        <constructor-arg ref="packageIngestCompleteProcessor"/>
        <constructor-arg ref="packageIngestStatusProcessor"/>
    </bean>
    
    <rabbit:admin connection-factory="connectionFactory"/>

    <!-- Create the producer -->
    <rabbit:template id="rabbitTemplate" exchange="chronopolis-control" 
                     connection-factory="connectionFactory"
                     mandatory="true" />

    <!--
                     confirm-callback="confirmCallback"
                     return-callback=""/> 
                     -->

    <bean id="producer" class="org.chronopolis.amqp.TopicProducer">
        <constructor-arg index="0" ref="rabbitTemplate"/>
    </bean>

</beans>